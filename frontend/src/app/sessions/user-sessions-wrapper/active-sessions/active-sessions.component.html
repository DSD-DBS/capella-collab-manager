<!--
~ SPDX-FileCopyrightText: Copyright DB InfraGO AG and contributors
~ SPDX-License-Identifier: Apache-2.0
-->

<h1 class="text-2xl">Active Sessions</h1>

<div class="flex flex-col gap-2">
  <a
    class="w-full"
    mat-flat-button
    color="primary"
    type="submit"
    routerLink="/session-viewer"
    [queryParams]="{
      'session-id': (selectedSessionIDs$ | async),
      'window-manager': 'tiling',
    }"
    [disabled]="!(selectedSessionIDs$ | async)?.length"
  >
    <div>
      Open selected sessions
      <span class="hidden sm:inline">in internal session viewer</span>
    </div>
    <mat-icon iconPositionEnd>keyboard_arrow_right</mat-icon>
  </a>

  @if ((sessions | async) === undefined) {
    <ngx-skeleton-loader
      appearance="circle"
      [theme]="{
        'border-radius': '5px',
        height: '150px',
        width: '100%',
        border: '1px solid white',
        margin: 0,
      }"
    ></ngx-skeleton-loader>
  } @else if ((sessions | async)?.length === 0) {
    <div class="rounded-md border px-3 py-2">
      <h2 class="text-xl font-medium">No active sessions</h2>
      <div class="text-sm">
        There are no active sessions for your user in our system. <br />
      </div>
    </div>
  } @else if ((sessions | async)?.length !== 0) {
    @for (session of sessions | async; track session.id) {
      <div class="collab-card">
        <div class="ml-[-10px] flex min-h-12 items-center pb-2">
          <mat-checkbox
            color="primary"
            [(ngModel)]="session.selected"
          ></mat-checkbox>
          <div class="grow">
            <h3 class="text-balance font-bold leading-tight">
              {{ session.version.tool.name }} ({{ session.version.name }})
              <span class="text-sm font-medium">
                via
                {{ session.connection_method?.name }}
              </span>
            </h3>
            <div class="text-pretty text-xs">
              @if (isPersistentSession(session)) {
                Persistent workspace session created
                <app-relative-time [date]="session.created_at" />
              } @else if (isReadonlySession(session)) {
                Read-Only session created
                <app-relative-time [date]="session.created_at" />
              }
            </div>
          </div>

          <div>
            @if ((feedbackService.feedbackConfig$ | async)?.on_session_card) {
              <button
                mat-icon-button
                color="primary"
                (click)="
                  feedbackService.showDialog([session], 'On session card')
                "
                matTooltip="Give feedback"
                matTooltipPosition="above"
              >
                <mat-icon>feedback</mat-icon>
              </button>
            }
          </div>
        </div>

        <div class="mb-1 space-y-1.5">
          <h3
            class="flex items-center justify-center gap-2 rounded py-1 text-center !text-white"
            [ngClass]="
              sessionService.beautifyState(
                session.preparation_state,
                session.state
              ).css
            "
            [matTooltip]="
              sessionService.beautifyState(
                session.preparation_state,
                session.state
              ).info
            "
          >
            <mat-icon
              >{{
                sessionService.beautifyState(
                  session.preparation_state,
                  session.state
                ).icon
              }}
            </mat-icon>
            {{
              sessionService.beautifyState(
                session.preparation_state,
                session.state
              ).text
            }}
          </h3>
          @let remainingMinutes = minutesUntilSessionTermination(session);
          @if (remainingMinutes !== null && remainingMinutes < 30) {
            <div
              class="flex items-center gap-2 rounded border border-yellow-400 bg-yellow-300 px-2 py-1
                shadow"
            >
              <mat-icon class="shrink-0">warning</mat-icon>
              <div>
                This session will automatically terminate
                <app-relative-time
                  [date]="addMinutes(Date.now(), remainingMinutes)"
                />
                if you do not interact with it.
              </div>
            </div>
          }

          @if (session.shared_with.length > 0 && !isSessionShared(session)) {
            <div
              class="flex items-center gap-2 rounded border px-2 py-1 shadow"
            >
              <mat-icon class="shrink-0">share</mat-icon>
              <div>
                You're sharing this session with
                @for (
                  sharedSession of session.shared_with;
                  track sharedSession.user.id
                ) {
                  <a
                    class="text-primary"
                    [routerLink]="['/user/' + sharedSession.user.id]"
                  >
                    {{ sharedSession.user.name }}
                  </a>
                  @if (!$last) {
                    +
                  }
                }
              </div>
            </div>
          }

          @if (isSessionShared(session)) {
            <div
              class="flex items-center gap-2 rounded border px-2 py-1 shadow"
            >
              <mat-icon class="shrink-0">share</mat-icon>
              <div>
                This session is shared with you and was created by
                <a
                  class="text-primary"
                  [routerLink]="['/user/' + session.owner.id]"
                  >{{ session.owner.name }}
                </a>
              </div>
            </div>
          }
        </div>
        <div class="flex flex-wrap justify-between">
          @if (!isSessionShared(session)) {
            <button
              mat-button
              color="warn"
              (click)="openDeletionDialog([session])"
            >
              Terminate
              <mat-icon>close</mat-icon>
            </button>
          }

          <button
            mat-button
            color="primary"
            (click)="openConnectDialog(session)"
            [disabled]="
              !sessionService.beautifyState(
                session.preparation_state,
                session.state
              ).success
            "
          >
            Connect
            <mat-icon>open_in_browser</mat-icon>
          </button>

          @if (!isSessionShared(session)) {
            <button
              mat-button
              color="primary"
              (click)="openShareDialog(session)"
              [disabled]="!session.connection_method?.sharing?.enabled"
            >
              Share
              <mat-icon> screen_share</mat-icon>
            </button>
          }
          @if (!isSessionShared(session)) {
            <button
              mat-button
              color="primary"
              (click)="uploadFileDialog(session)"
              [disabled]="
                !sessionService.beautifyState(
                  session.preparation_state,
                  session.state
                ).success
              "
            >
              File browser
              <mat-icon>insert_drive_file</mat-icon>
            </button>
          }
        </div>
      </div>
    }
  }
</div>
