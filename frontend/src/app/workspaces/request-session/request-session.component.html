<!--
 ~ SPDX-FileCopyrightText: Copyright DB Netz AG and the capella-collab-manager contributors
 ~ SPDX-License-Identifier: Apache-2.0
 -->

<div class="repository-selection">
  <form [formGroup]="repositoryFormGroup">
    <div class="workspace-toggle">
      <a
        (click)="persistentWorkspaceHelpIsOpen = !persistentWorkspaceHelpIsOpen"
        mat-icon-button
        cdkOverlayOrigin
        #overlayOriginPersistentWorkspace="cdkOverlayOrigin"
        class="help-button-workspace"
        ><mat-icon>help</mat-icon></a
      >
      <ng-template
        cdkConnectedOverlay
        [cdkConnectedOverlayOrigin]="overlayOriginPersistentWorkspace"
        [cdkConnectedOverlayOpen]="persistentWorkspaceHelpIsOpen"
      >
        <div class="help">
          Persistent Workspaces will store all the changes you make on models.
          Additionally, newly created projects will be stored in your personal
          workspace. <br />
          <b
            >If you don't plan on making changes to the models, please use the
            "Read-only Workspace" option.</b
          >
          <br />
          Please note that you have only access to T4C models if a Repository
          Manager gave you access and you have set the password for the
          repository in your settings.
        </div>
      </ng-template>
      Persistent Workspace &nbsp;
      <mat-slide-toggle formControlName="workspaceSwitch"></mat-slide-toggle>
      &nbsp; Read-only Workspace
      <a
        (click)="cleanWorkspaceHelpIsOpen = !cleanWorkspaceHelpIsOpen"
        mat-icon-button
        cdkOverlayOrigin
        #overlayOriginCleanWorkspace="cdkOverlayOrigin"
        class="help-button-workspace"
        ><mat-icon>help</mat-icon></a
      >
      <ng-template
        cdkConnectedOverlay
        [cdkConnectedOverlayOrigin]="overlayOriginCleanWorkspace"
        [cdkConnectedOverlayOpen]="cleanWorkspaceHelpIsOpen"
      >
        <div class="help">
          Due to the limitation of licences, we decided to offer a new "Read
          only" option.<br />
          <b>Any changes made in this session will NOT be saved.</b>
          <br />
          This will give more users the opportunity to work on the models since
          "Read only" users do not need a license.
          <br />
          A model with this option always has the state from last night (3 a.m.)
        </div>
      </ng-template>
    </div>
    <br />

    <div class="center">
      <div class="clean-workspace" *ngIf="workspaceSwitch.value">
        <mat-form-field appearance="fill">
          <mat-label>Repository</mat-label>
          <mat-select
            formControlName="repository"
            (selectionChange)="setPermissionsAndWarningsByName($event)"
          >
            <mat-option
              *ngFor="let repository of ownProjects"
              [value]="repository.project_name"
              >{{ repository.project_name }}
            </mat-option>
          </mat-select>
          <mat-error>Please select a repository!</mat-error> </mat-form-field
        ><br />
        <mat-spinner
          class="small-spinner"
          mode="indeterminate"
          *ngIf="showSmallSpinner"
        >
        </mat-spinner>

        <div *ngIf="chosenRepository">
          <mat-checkbox class="checkbox" (change)="changeAllBranches()">
            Download all branches
          </mat-checkbox>

          <form [formGroup]="referenceDepthFormGroup">
            <mat-form-field appearance="fill">
              <mat-label>Branch, tag or revision</mat-label>
              <mat-select
                formControlName="reference"
                (selectionChange)="changeIsTag($event)"
                [disabled]="allBranches"
              >
                <mat-optgroup label="branch">
                  <mat-option *ngFor="let option of branches" [value]="option">
                    {{ option }}
                  </mat-option>
                </mat-optgroup>
                <mat-optgroup label="tag">
                  <mat-option *ngFor="let option of tags" [value]="option">
                    {{ option }}
                  </mat-option>
                </mat-optgroup>
              </mat-select>
              <mat-error
                >Please select a branch or tag!</mat-error
              > </mat-form-field
            ><br />

            <mat-form-field appearance="fill">
              <mat-label>Commits history depth</mat-label>
              <mat-select formControlName="historyDepth" [disabled]="isTag">
                <mat-option *ngFor="let depth of history" [value]="depth"
                  >{{ depth }}
                </mat-option>
              </mat-select>
              <mat-error>Please select a history depth!</mat-error>
            </mat-form-field>

            <br />
          </form>
        </div>
      </div>

      <div class="center" *ngFor="let warning of warnings">
        <app-warning
          [warning]="warning"
          [persistent]="!workspaceSwitch.value"
        ></app-warning>
      </div>
      <button
        mat-flat-button
        color="primary"
        (click)="requestSession()"
        [disabled]="
          showSpinner ||
          !repositoryFormGroup.valid ||
          (workspaceSwitch &&
            !chosenRepository &&
            !referenceDepthFormGroup.valid)
        "
      >
        Request Session <mat-icon>keyboard_arrow_right</mat-icon>
      </button>
    </div>
  </form>
</div>

<mat-spinner class="big-spinner" *ngIf="showSpinner"></mat-spinner>
<app-session-creation-progress
  *ngIf="creationSuccessful"
  [session]="session"
></app-session-creation-progress>
