<!--
 ~ SPDX-FileCopyrightText: Copyright DB InfraGO AG and contributors
 ~ SPDX-License-Identifier: Apache-2.0
 -->

<form class="pb-4" [formGroup]="form">
  <mat-form-field id="search" appearance="outline" class="w-full">
    <mat-label>Search</mat-label>
    <input
      autocomplete="off"
      matInput
      placeholder="Project Name"
      type="text"
      formControlName="search"
    />
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  <div class="-mt-2 flex gap-3">
    <mat-chip-listbox formControlName="projectType">
      <mat-chip-option value="general">Projects</mat-chip-option>
      <mat-chip-option value="training">
        <div class="flex items-center gap-1">
          <mat-icon inline>school</mat-icon><span>Trainings</span>
        </div>
      </mat-chip-option>
    </mat-chip-listbox>

    <div class="border-l"></div>

    <mat-chip-listbox formControlName="projectVisibility">
      <mat-chip-option value="internal">
        <div class="flex items-center gap-1">
          <mat-icon inline>lock_open</mat-icon><span>Internal</span>
        </div>
      </mat-chip-option>
      <mat-chip-option value="private">
        <div class="flex items-center gap-1">
          <mat-icon inline>lock</mat-icon><span>Private</span>
        </div>
      </mat-chip-option>
    </mat-chip-listbox>
  </div>
</form>

<div class="flex flex-wrap gap-5">
  <a routerLink="/projects/create" class="w-full sm:w-fit">
    <div matRipple class="mat-card-overview new collab-card !m-0">
      <div class="content flex flex-col items-center justify-center">
        Add New Project <br />
        <div class="icon">
          <app-mat-icon size="70px">add_circle_outline</app-mat-icon>
        </div>
      </div>
    </div>
  </a>
  @if ((filteredProjects$ | async) === undefined) {
    <app-mat-card-overview-skeleton-loader
      class="contents"
    ></app-mat-card-overview-skeleton-loader>
  }

  @if (filteredProjects$ | async) {
    @for (project of (filteredProjects$ | async)!; track project.slug) {
      <a [routerLink]="['/project', project.slug]" class="w-full sm:w-fit">
        <div
          [ngClass]="{ 'bg-archived': project.is_archived }"
          matRipple
          class="mat-card-overview collab-card !m-0"
        >
          <div class="header flex-row items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              @if (project.type === "training") {
                <mat-icon class="shrink-0">school</mat-icon>
              }
              @if (project.visibility === "private") {
                <mat-icon class="shrink-0">lock</mat-icon>
              } @else {
                <mat-icon class="shrink-0">lock_open</mat-icon>
              }

              <span class="line-clamp-1">{{ project.name }}</span>
            </div>

            <button
              mat-icon-button
              class="!m-0 !size-6 !p-0"
              (click)="toggleFavorite($event, project.id)"
            >
              @if (projectFavoritesService.isFavorite(project.id)) {
                <!--Using svgs of the favorite and unfavorite icons here -->
                <!--Otherwise we would have to load all material symbols filled for one icon -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="undefined"
                >
                  <path
                    d="m480-120-58-52q-101-91-167-157T150-447.5Q111-500 95.5-544T80-634q0-94 63-157t157-63q52 0 99 22t81 62q34-40 81-62t99-22q94 0 157 63t63 157q0 46-15.5 90T810-447.5Q771-395 705-329T538-172l-58 52Z"
                  />
                </svg>
              } @else {
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  height="24px"
                  viewBox="0 -960 960 960"
                  width="24px"
                  fill="undefined"
                >
                  <path
                    d="m480-120-58-52q-101-91-167-157T150-447.5Q111-500 95.5-544T80-634q0-94 63-157t157-63q52 0 99 22t81 62q34-40 81-62t99-22q94 0 157 63t63 157q0 46-15.5 90T810-447.5Q771-395 705-329T538-172l-58 52Zm0-108q96-86 158-147.5t98-107q36-45.5 50-81t14-70.5q0-60-40-100t-100-40q-47 0-87 26.5T518-680h-76q-15-41-55-67.5T300-774q-60 0-100 40t-40 100q0 35 14 70.5t50 81q36 45.5 98 107T480-228Zm0-273Z"
                  />
                </svg>
              }
            </button>
          </div>
          <div class="p-3">
            <div class="line-clamp-4">
              @if (project.description) {
                {{ project.description }}
              } @else {
                No description provided.
              }
            </div>
            <div class="fixed bottom-2 right-2 text-right text-stone-500">
              <div>
                {{ project.visibility === "internal" ? "Internal" : "Private" }}
                {{ project.type === "training" ? "training" : "project" }}
              </div>
              <div>
                {{ project.users.leads }} project admin(s),
                {{ project.users.contributors }} contributor(s),
                {{ project.users.subscribers }}
                subscriber(s)
              </div>
              @if (project.is_archived) {
                Archived
              }
            </div>
          </div>
        </div>
      </a>
    }
  }
</div>
